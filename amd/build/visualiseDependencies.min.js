define("block_availdep/visualiseDependencies",["exports","core/ajax","block_availdep/graphManipulation"],(function(_exports,_ajax,_graphManipulation){var obj;
/**
   * Visualise dependencies.
   *
   * @copyright  2022 Paola Maneggia, Mathias Kegelmann
   * @author     Paola Maneggia <paola.maneggia@gmail.com>, Mathias Kegelmann <mathias.kegelmann@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   * @module     block/availdep
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj};_exports.init=(courseid,fullparam)=>{Promise.all(_ajax.default.call([{methodname:"core_get_string",args:{stringid:"missing",component:"availability_completion"}},{methodname:"block_availdep_fetch_course_modules_with_names_and_dependencies",args:{courseid:courseid}}])).then((_ref=>{let simulation,[missingString,dependencies]=_ref;var allEdges;!function(dimensions){d3.select("svg.availdep").attr("width",dimensions.width).attr("height",dimensions.height).attr("viewBox",-dimensions.width/2+" "+-dimensions.height/2+" "+dimensions.width+" "+dimensions.height),function(){let dev=d3.select("g.availdep").append("defs");dev.append("marker").attr("id","arrow").attr("viewBox","0 0 10 10").attr("refX",23).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",6).attr("markerHeight",8).attr("orient","auto").append("path").attr("fill","#516E84").attr("d","M 0 0 L 10 5 L 0 10 z"),dev.append("marker").attr("id","arrowToActivity").attr("viewBox","0 0 10 10").attr("refX",52).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",6).attr("markerHeight",8).attr("orient","auto").append("path").attr("fill","#516E84").attr("d","M 0 0 L 10 5 L 0 10 z"),dev.append("marker").attr("id","arrowToOperator").attr("viewBox","0 0 10 10").attr("refX",27).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",6).attr("markerHeight",8).attr("orient","auto").append("path").attr("fill","#516E84").attr("d","M 0 0 L 10 5 L 0 10 z")}(),d3.select("g.availdep defs").append("filter").attr("id","textShadow").append("feDropShadow").attr("dx",0).attr("dy",0).attr("stdDeviation",2).attr("flood-color","white").attr("flood-opacity",1)}(function(){var _screen$orientation;document.querySelector("svg.availdep");console.log("Paola element "+document.querySelector("div.drawercontent").clientWidth);let width=document.querySelector("div.drawercontent").clientWidth,orientation=null===(_screen$orientation=screen.orientation)||void 0===_screen$orientation?void 0:_screen$orientation.type;return{width:width,height:"landscape-primary"===orientation?1.3*width:.6*width}}()),dependencies.forEach((d=>{d.depend=JSON.parse(d.depend)})),dependencies=(0,_graphManipulation.removeDisconnectedNodes)(dependencies),(0,_graphManipulation.fixDanglingReferences)(dependencies,missingString),"no"===fullparam?(simulation=function(dependencies){return d3.forceSimulation(dependencies).force("x0",d3.forceX()).force("y0",d3.forceY()).force("collide",d3.forceCollide().radius(20)).force("charge",d3.forceManyBody().strength(-300)).force("link",d3.forceLink(function(dependencies){let leaves=depend=>depend.c.flatMap((d=>d.op?leaves(d):"completion"===d.type?d.cm:[]));return dependencies.filter((_ref2=>{let{depend:depend}=_ref2;return null!==depend})).map((_ref3=>{let{id:id,name:name,depend:depend,predecessor:predecessor}=_ref3;return leaves(depend).map((cm=>({target:id,source:-1===cm?predecessor:cm,name:name})))})).flat()}(dependencies)).distance(200).id((d=>d.id)))}(dependencies),function(simulation){sEdges=simulation.force("link").links(),d3.select("g.availdep").append("g").selectAll("line").data(sEdges).enter().append("line").attr("stroke","#516E84").attr("stroke-width","2px").attr("stroke-linecap","round").attr("marker-end","url(#arrow)"),sNodes=simulation.nodes(),d3.select("g.availdep").append("g").selectAll("circle").data(sNodes).join("circle").attr("fill",(n=>-2===n.id?"#FF2020":"#AEDAEA")).attr("stroke","white").attr("r",16),d3.select("g.availdep").append("g").selectAll("text").data(sNodes).join("text").attr("fill","#364958").attr("font-family","sans-serif").attr("font-weight","bold").clone().lower().attr("stroke","white").attr("stroke-width",4).attr("stroke-opacity",.5);var sNodes;var sEdges}(simulation)):(simulation=function(dependencies){let{edges:edges,nodes:nodes}=function(dependencies){let onlyNonCompletionConditionsIn=function(dependList){return 0===dependList.filter((c=>c.type&&"completion"==c.type||!c.type&&c.op)).length},uid=0,getNextUID=function(){return"uid_"+uid++},extractActivityNodes=function(dependencies){return dependencies.map((d=>({id:d.id,name:d.name,genus:"activity",isSource:0,isTarget:0})))},edges=[],nodes=extractActivityNodes(dependencies),extractEdgesAndNodes=function(id,toGenus,dependList,predecessor){dependList.forEach((el=>{if(el.type||!el.op||onlyNonCompletionConditionsIn(el.c)){if("completion"===el.type&&el.e>0){let newEdge={target:id,source:-1===el.cm?predecessor:el.cm,toGenus:toGenus},sn=nodes.find((n=>n.id===newEdge.source));sn.isSource=sn.isSource+.6>1.5?1.5:sn.isSource+.6,edges.push(newEdge)}else if("completion"===el.type&&0===el.e){let newNode={id:getNextUID(),name:"not",genus:"operator",isTarget:.1,isSource:.1},newEdgeFromNot={target:id,source:newNode.id,toGenus:toGenus},newEdgeToNot={target:newNode.id,source:-1===el.cm?predecessor:el.cm,toGenus:"operator"};nodes.push(newNode),edges.push(newEdgeFromNot),edges.push(newEdgeToNot);let sn=nodes.find((n=>n.id===newEdgeToNot.source));sn.isSource=sn.isSource+.6>1.5?1.5:sn.isSource+.6}}else{let newNode={id:getNextUID(),name:el.op,genus:"operator",isTarget:.1,isSource:.1};nodes.push(newNode);let newEdge={target:id,source:newNode.id,toGenus:toGenus};edges.push(newEdge),extractEdgesAndNodes(newNode.id,"operator",el.c,predecessor)}}))};return dependencies.forEach((a=>{null!==a.depend&&(nodes.find((n=>n.id===a.id)).isTarget=.9,extractEdgesAndNodes(a.id,"activity",[a.depend],a.predecessor))})),{edges:edges,nodes:nodes}}(dependencies);return d3.forceSimulation(nodes).force("x0",d3.forceX()).force("y0",d3.forceY()).force("isSource",d3.forceX(NaN).strength((n=>n.isSource))).force("isTarget",d3.forceX(NaN).strength((n=>n.isTarget))).force("collide",d3.forceCollide(100).radius((n=>30+("activity"===n.genus?50:20)))).force("charge",d3.forceManyBody().strength(-300)).force("link",d3.forceLink(edges).distance(50).id((d=>d.id)))}(dependencies),function(simulation){sEdges=simulation.force("link").links(),d3.select("g.availdep").append("g").selectAll("line").data(sEdges).enter().append("line").attr("stroke","#364958").attr("stroke-opacity",.7).attr("stroke-width","2px").attr("stroke-linecap","round").attr("marker-end",(e=>"activity"===e.toGenus?"url(#arrowToActivity":"url(#arrowToOperator")),sNodes=simulation.nodes(),d3.select("g.availdep").append("g").selectAll("circle").data(sNodes).join("circle").attr("fill",(n=>"activity"===n.genus?-2===n.id?"#FF2020":"#AEDAEA":"&"===n.name?"#FFB400":"|"===n.name?"#CEFF1A":"!&"===n.name?"#F9CFF2":"!|"===n.name?"#D1FAFF":"not"===n.name?"#EA7B5D":"#D1FAFF")).attr("stroke","white").attr("stroke-width",3).attr("r",(n=>"activity"===n.genus?50:20)),d3.select("g.availdep").append("g").selectAll("text").data(sNodes).join("text").attr("fill","#364958").attr("font-family","sans-serif").attr("font-weight","bold").attr("text-anchor","middle").attr("dx",-5).attr("dominant-baseline","middle").attr("dy",5).attr("filter","url(#textShadow)");var sNodes;var sEdges}(simulation)),edges=d3.select("g.availdep").selectAll("line"),nodes=d3.select("g.availdep").selectAll("circle"),labels=d3.select("g.availdep").selectAll("text"),allEdges=edges,nodes.data().forEach((n=>function(node,allEdges){let aNodes=new Set,aEdges=new Set,toBeExaminedNodes=[node];for(;toBeExaminedNodes.length;){let currentNode=toBeExaminedNodes.shift();aNodes.add(currentNode),allEdges.data().forEach((ed=>{ed.target.id===currentNode.id&&(aEdges.add(ed),aNodes.has(ed.source)||toBeExaminedNodes.push(ed.source))}))}node.ancestors=[...aNodes].concat([...aEdges])}(n,allEdges))),simulation.on("tick",tick),function(simulation){nodes.call(d3.drag().on("start",((event,n)=>{event.active||simulation.alphaTarget(.3).restart(),n.fx=event.x,n.fy=event.y})).on("drag",((event,n)=>{n.fx=event.x,n.fy=event.y})).on("end",(event=>{event.active||simulation.alphaTarget(0)})))}(simulation),nodes.on("click",highlightDependencies)})).catch()};let edges,nodes,labels,toggleHighlight=0;function tick(){nodes.attr("cx",(n=>n.x)).attr("cy",(n=>n.y)),edges.attr("x1",(e=>e.source.x)).attr("y1",(e=>e.source.y)).attr("x2",(e=>e.target.x)).attr("y2",(e=>e.target.y)),labels.attr("x",(n=>n.x+5)).attr("y",(n=>n.y-5)).text((n=>n.name))}function isAncestor(edgeOrNode,node){return node.ancestors.includes(edgeOrNode)}function highlightDependencies(){if(0===toggleHighlight){let d=d3.select(this).data()[0];nodes.style("opacity",(function(o){return isAncestor(o,d)?1:.1})),edges.style("opacity",(function(o){return isAncestor(o,d)?1:.1})),toggleHighlight=1}else nodes.style("opacity",1),edges.style("opacity",1),toggleHighlight=0}}));

//# sourceMappingURL=visualiseDependencies.min.js.map