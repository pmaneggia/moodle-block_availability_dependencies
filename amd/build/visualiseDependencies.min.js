define ("block_availability_dependencies/visualiseDependencies",["exports","core/ajax"],function(a,b){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=function(a){return a&&a.__esModule?a:{default:a}}(b);function c(a){return g(a)||f(a)||e(a)||d()}function d(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function e(a,b){if(!a)return;if("string"==typeof a)return h(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return h(a,b)}function f(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function g(a){if(Array.isArray(a))return h(a)}function h(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}var E=function(a,c){c=c;var d=b.default.call([{methodname:"block_availability_dependencies_fetch_course_modules_with_names_and_dependencies",args:{courseid:a}}]);d[0].fail(function(a){return console.log(a)}).then(function(a){var b=l();i(b);a.forEach(function(a){a.depend=JSON.parse(a.depend)});var d;if("no"===c){d=m(a);q(d)}else{d=n(a);s(d)}w();A(N);d.on("tick",x);y(d);z(d)})};a.init=E;var F=0,G="#AEDAEA",H="#364958",I="#516E84",J=50,K=20,L=2,M;function i(a){d3.select("svg.availability_dependencies").attr("width",a.width).attr("height",a.height).attr("viewBox",-a.width/2+" "+-a.height/2+" "+a.width+" "+a.height);j();k()}function j(){var a=d3.select("g.availability_dependencies").append("defs");a.append("marker").attr("id","arrow").attr("viewBox","0 0 10 10").attr("refX",23).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",6).attr("markerHeight",8).attr("orient","auto").append("path").attr("fill",I).attr("d","M 0 0 L 10 5 L 0 10 z");a.append("marker").attr("id","arrowToActivity").attr("viewBox","0 0 10 10").attr("refX",52).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",6).attr("markerHeight",8).attr("orient","auto").append("path").attr("fill",I).attr("d","M 0 0 L 10 5 L 0 10 z");a.append("marker").attr("id","arrowToOperator").attr("viewBox","0 0 10 10").attr("refX",27).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",6).attr("markerHeight",8).attr("orient","auto").append("path").attr("fill",I).attr("d","M 0 0 L 10 5 L 0 10 z")}function k(){var a=d3.select("g.availability_dependencies defs");a.append("filter").attr("id","textShadow").append("feDropShadow").attr("dx",0).attr("dy",0).attr("stdDeviation",2).attr("flood-color","white").attr("flood-opacity",1)}function l(){var a,b=document.querySelector("svg.availability_dependencies"),c=b.parentNode.clientWidth,d=null===(a=screen.orientation)||void 0===a?void 0:a.type,e="portrait-primary"===d?1.3*c:.6*c;M=c;return{width:c,height:e}}function m(a){return d3.forceSimulation(a).force("x0",d3.forceX()).force("y0",d3.forceY()).force("collide",d3.forceCollide().radius(20)).force("charge",d3.forceManyBody().strength(-300)).force("link",d3.forceLink(o(a)).distance(200).id(function(a){return a.id}))}function n(a){var b=p(a),c=b.edges,d=b.nodes;return d3.forceSimulation(d).force("x0",d3.forceX()).force("y0",d3.forceY()).force("isSource",d3.forceX(-M/3).strength(function(a){return a.isSource})).force("isTarget",d3.forceX(M/3).strength(function(a){return a.isTarget})).force("collide",d3.forceCollide(100).radius(function(a){return("activity"===a.genus?J:K)+30})).force("charge",d3.forceManyBody().strength(-300)).force("link",d3.forceLink(c).distance(50).id(function(a){return a.id}))}function o(a){var b=function(a){return a.c.flatMap(function(a){return a.op?b(a):"completion"===a.type?a.cm:[]})};return a.filter(function(a){var b=a.id,c=a.name,d=a.depend,e=a.predecessor;return null!==d}).map(function(a){var c=a.id,d=a.name,e=a.depend,f=a.predecessor;return b(e).map(function(a){return{target:c,source:-1===a?f:a,name:d}})}).flat()}function p(a){function b(a){return 0===a.filter(function(a){return a.type&&"completion"==a.type||!a.type&&a.op}).length}var e=0;function c(){return"uid_"+e++}var f=[],g=function(a){return a.map(function(a){return{id:a.id,name:a.name,genus:"activity",isSource:0,isTarget:0}})}(a);function d(a,e,h,i){h.forEach(function(h){if(!h.type&&h.op&&!b(h.c)){var p={id:c(),name:h.op,genus:"operator",isTarget:.1,isSource:.1};g.push(p);var q={target:a,source:p.id,toGenus:e};f.push(q);d(p.id,"operator",h.c,i)}else if("completion"===h.type&&0<h.e){var j={target:a,source:-1===h.cm?i:h.cm,toGenus:e},k=g.find(function(a){return a.id===j.source});k.isSource=1.5<k.isSource+.6?1.5:k.isSource+.6;f.push(j)}else if("completion"===h.type&&0===h.e){var l={id:c(),name:"not",genus:"operator",isTarget:.1,isSource:.1},m={target:a,source:l.id,toGenus:e},o={target:l.id,source:-1===h.cm?i:h.cm,toGenus:"operator"};g.push(l);f.push(m);f.push(o);var r=g.find(function(a){return a.id===o.source});r.isSource=1.5<r.isSource+.6?1.5:r.isSource+.6}})}a.forEach(function(b){if(null!==b.depend){g.find(function(a){return a.id===b.id}).isTarget=.9;d(b.id,"activity",[b.depend],b.predecessor)}});return{edges:f,nodes:g}}function q(a){r(a.force("link").links());u(a.nodes())}function r(a){d3.select("g.availability_dependencies").append("g").selectAll("line").data(a).enter().append("line").attr("stroke",I).attr("stroke-width",L+"px").attr("stroke-linecap","round").attr("marker-end","url(#arrow)")}function s(a){t(a.force("link").links());v(a.nodes())}function t(a){d3.select("g.availability_dependencies").append("g").selectAll("line").data(a).enter().append("line").attr("stroke",H).attr("stroke-opacity",.7).attr("stroke-width",L+"px").attr("stroke-linecap","round").attr("marker-end",function(a){return"activity"===a.toGenus?"url(#arrowToActivity":"url(#arrowToOperator"})}function u(a){d3.select("g.availability_dependencies").append("g").selectAll("circle").data(a).join("circle").attr("fill",G).attr("stroke","white").attr("r",16);d3.select("g.availability_dependencies").append("g").selectAll("text").data(a).join("text").attr("fill",H).attr("font-family","sans-serif").attr("font-weight","bold").clone().lower().attr("stroke","white").attr("stroke-width",4).attr("stroke-opacity",.5)}function v(a){d3.select("g.availability_dependencies").append("g").selectAll("circle").data(a).join("circle").attr("fill",function(a){return"activity"===a.genus?G:"&"===a.name?"#FFB400":"|"===a.name?"#CEFF1A":"!&"===a.name?"#F9CFF2":"!|"===a.name?"#D1FAFF":"not"===a.name?"#EA7B5D":"#D1FAFF"}).attr("stroke","white").attr("stroke-width",3).attr("r",function(a){return"activity"===a.genus?J:K});d3.select("g.availability_dependencies").append("g").selectAll("text").data(a).join("text").attr("fill",H).attr("font-family","sans-serif").attr("font-weight","bold").attr("text-anchor","middle").attr("dx",-5).attr("dominant-baseline","middle").attr("dy",5).attr("filter","url(#textShadow)")}var N,O,P;function w(){N=d3.select("g.availability_dependencies").selectAll("line");O=d3.select("g.availability_dependencies").selectAll("circle");P=d3.select("g.availability_dependencies").selectAll("text")}function x(){O.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});N.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});P.attr("x",function(a){return a.x+5}).attr("y",function(a){return a.y-5}).text(function(a){return a.name})}function y(a){O.call(d3.drag().on("start",function(b,c){if(!b.active)a.alphaTarget(.3).restart();c.fx=b.x;c.fy=b.y}).on("drag",function(a,b){b.fx=a.x;b.fy=a.y}).on("end",function(b){if(!b.active)a.alphaTarget(0)}))}function z(){O.on("click",D)}function A(a){return O.data().forEach(function(b){return B(b,a)})}function B(a,b){var d=new Set,e=new Set,f=[a],g=function(){var a=f.shift();d.add(a);b.data().forEach(function(b){if(b.target.id===a.id){e.add(b);if(!d.has(b.source)){f.push(b.source)}}})};while(f.length){g()}a.ancestors=c(d).concat(c(e))}function C(a,b){return b.ancestors.includes(a)}function D(){if(0===F){var a=d3.select(this).data()[0];O.style("opacity",function(b){return C(b,a)?1:.1});N.style("opacity",function(b){return C(b,a)?1:.1});F=1}else{O.style("opacity",1);N.style("opacity",1);F=0}}});
//# sourceMappingURL=visualiseDependencies.min.js.map
