define("block_availdep/visualiseDependencies",["exports","core/ajax","block_availdep/graphManipulation"],(function(_exports,_ajax,_graphManipulation){var obj;function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj};var full="no";_exports.init=function(courseid,fullparam){full=fullparam,_ajax.default.call([{methodname:"block_availdep_fetch_course_modules_with_names_and_dependencies",args:{courseid:courseid}}])[0].then((function(dependencies){var _screen$orientation,width,orientation,simulation,allEdges;!function(dimensions){d3.select("svg.availdep").attr("width",dimensions.width).attr("height",dimensions.height).attr("viewBox",-dimensions.width/2+" "+-dimensions.height/2+" "+dimensions.width+" "+dimensions.height),dev=d3.select("g.availdep").append("defs"),dev.append("marker").attr("id","arrow").attr("viewBox","0 0 10 10").attr("refX",23).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",6).attr("markerHeight",8).attr("orient","auto").append("path").attr("fill","#516E84").attr("d","M 0 0 L 10 5 L 0 10 z"),dev.append("marker").attr("id","arrowToActivity").attr("viewBox","0 0 10 10").attr("refX",52).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",6).attr("markerHeight",8).attr("orient","auto").append("path").attr("fill","#516E84").attr("d","M 0 0 L 10 5 L 0 10 z"),dev.append("marker").attr("id","arrowToOperator").attr("viewBox","0 0 10 10").attr("refX",27).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",6).attr("markerHeight",8).attr("orient","auto").append("path").attr("fill","#516E84").attr("d","M 0 0 L 10 5 L 0 10 z"),d3.select("g.availdep defs").append("filter").attr("id","textShadow").append("feDropShadow").attr("dx",0).attr("dy",0).attr("stdDeviation",2).attr("flood-color","white").attr("flood-opacity",1);var dev}((width=document.querySelector("svg.availdep").parentNode.clientWidth,orientation=null===(_screen$orientation=screen.orientation)||void 0===_screen$orientation?void 0:_screen$orientation.type,svgWidth=width,{width:width,height:"portrait-primary"===orientation?1.3*width:.6*width})),dependencies.forEach((function(d){d.depend=JSON.parse(d.depend)})),dependencies=(0,_graphManipulation.removeDisconnectedNodes)(dependencies),(0,_graphManipulation.fixDanglingReferences)(dependencies),"no"===full?(simulation=function(dependencies){return d3.forceSimulation(dependencies).force("x0",d3.forceX()).force("y0",d3.forceY()).force("collide",d3.forceCollide().radius(20)).force("charge",d3.forceManyBody().strength(-300)).force("link",d3.forceLink(function(dependencies){var leaves=function leaves(depend){return depend.c.flatMap((function(d){return d.op?leaves(d):"completion"===d.type?d.cm:[]}))};return dependencies.filter((function(_ref){return null!==_ref.depend})).map((function(_ref2){var id=_ref2.id,name=_ref2.name,depend=_ref2.depend,predecessor=_ref2.predecessor;return leaves(depend).map((function(cm){return{target:id,source:-1===cm?predecessor:cm,name:name}}))})).flat()}(dependencies)).distance(200).id((function(d){return d.id})))}(dependencies),function(simulation){sEdges=simulation.force("link").links(),d3.select("g.availdep").append("g").selectAll("line").data(sEdges).enter().append("line").attr("stroke","#516E84").attr("stroke-width","2px").attr("stroke-linecap","round").attr("marker-end","url(#arrow)"),sNodes=simulation.nodes(),d3.select("g.availdep").append("g").selectAll("circle").data(sNodes).join("circle").attr("fill","#AEDAEA").attr("stroke","white").attr("r",16),d3.select("g.availdep").append("g").selectAll("text").data(sNodes).join("text").attr("fill","#364958").attr("font-family","sans-serif").attr("font-weight","bold").clone().lower().attr("stroke","white").attr("stroke-width",4).attr("stroke-opacity",.5);var sNodes;var sEdges}(simulation)):(simulation=function(dependencies){var _computeEdgesAndNodes=function(dependencies){var onlyNonCompletionConditionsIn=function(dependList){return 0===dependList.filter((function(c){return c.type&&"completion"==c.type||!c.type&&c.op})).length},uid=0,getNextUID=function(){return"uid_"+uid++},extractActivityNodes=function(dependencies){return dependencies.map((function(d){return{id:d.id,name:d.name,genus:"activity",isSource:0,isTarget:0}}))},edges=[],nodes=extractActivityNodes(dependencies),extractEdgesAndNodes=function extractEdgesAndNodes(id,toGenus,dependList,predecessor){dependList.forEach((function(el){if(el.type||!el.op||onlyNonCompletionConditionsIn(el.c)){if("completion"===el.type&&el.e>0){var _newEdge={target:id,source:-1===el.cm?predecessor:el.cm,toGenus:toGenus},sn=nodes.find((function(n){return n.id===_newEdge.source}));sn.isSource=sn.isSource+.6>1.5?1.5:sn.isSource+.6,edges.push(_newEdge)}else if("completion"===el.type&&0===el.e){var _newNode={id:getNextUID(),name:"not",genus:"operator",isTarget:.1,isSource:.1},newEdgeFromNot={target:id,source:_newNode.id,toGenus:toGenus},newEdgeToNot={target:_newNode.id,source:-1===el.cm?predecessor:el.cm,toGenus:"operator"};nodes.push(_newNode),edges.push(newEdgeFromNot),edges.push(newEdgeToNot);var _sn=nodes.find((function(n){return n.id===newEdgeToNot.source}));_sn.isSource=_sn.isSource+.6>1.5?1.5:_sn.isSource+.6}}else{var newNode={id:getNextUID(),name:el.op,genus:"operator",isTarget:.1,isSource:.1};nodes.push(newNode);var newEdge={target:id,source:newNode.id,toGenus:toGenus};edges.push(newEdge),extractEdgesAndNodes(newNode.id,"operator",el.c,predecessor)}}))};return dependencies.forEach((function(a){null!==a.depend&&(nodes.find((function(n){return n.id===a.id})).isTarget=.9,extractEdgesAndNodes(a.id,"activity",[a.depend],a.predecessor))})),{edges:edges,nodes:nodes}}(dependencies),edges=_computeEdgesAndNodes.edges,nodes=_computeEdgesAndNodes.nodes;return d3.forceSimulation(nodes).force("x0",d3.forceX()).force("y0",d3.forceY()).force("isSource",d3.forceX(-svgWidth/3).strength((function(n){return n.isSource}))).force("isTarget",d3.forceX(svgWidth/3).strength((function(n){return n.isTarget}))).force("collide",d3.forceCollide(100).radius((function(n){return 30+("activity"===n.genus?50:20)}))).force("charge",d3.forceManyBody().strength(-300)).force("link",d3.forceLink(edges).distance(50).id((function(d){return d.id})))}(dependencies),function(simulation){sEdges=simulation.force("link").links(),d3.select("g.availdep").append("g").selectAll("line").data(sEdges).enter().append("line").attr("stroke","#364958").attr("stroke-opacity",.7).attr("stroke-width","2px").attr("stroke-linecap","round").attr("marker-end",(function(e){return"activity"===e.toGenus?"url(#arrowToActivity":"url(#arrowToOperator"})),sNodes=simulation.nodes(),d3.select("g.availdep").append("g").selectAll("circle").data(sNodes).join("circle").attr("fill",(function(n){return"activity"===n.genus?"#AEDAEA":"&"===n.name?"#FFB400":"|"===n.name?"#CEFF1A":"!&"===n.name?"#F9CFF2":"!|"===n.name?"#D1FAFF":"not"===n.name?"#EA7B5D":"#D1FAFF"})).attr("stroke","white").attr("stroke-width",3).attr("r",(function(n){return"activity"===n.genus?50:20})),d3.select("g.availdep").append("g").selectAll("text").data(sNodes).join("text").attr("fill","#364958").attr("font-family","sans-serif").attr("font-weight","bold").attr("text-anchor","middle").attr("dx",-5).attr("dominant-baseline","middle").attr("dy",5).attr("filter","url(#textShadow)");var sNodes;var sEdges}(simulation)),edges=d3.select("g.availdep").selectAll("line"),nodes=d3.select("g.availdep").selectAll("circle"),labels=d3.select("g.availdep").selectAll("text"),allEdges=edges,nodes.data().forEach((function(n){return function(node,allEdges){for(var aNodes=new Set,aEdges=new Set,toBeExaminedNodes=[node],_loop=function(){var currentNode=toBeExaminedNodes.shift();aNodes.add(currentNode),allEdges.data().forEach((function(ed){ed.target.id===currentNode.id&&(aEdges.add(ed),aNodes.has(ed.source)||toBeExaminedNodes.push(ed.source))}))};toBeExaminedNodes.length;)_loop();node.ancestors=_toConsumableArray(aNodes).concat(_toConsumableArray(aEdges))}(n,allEdges)})),simulation.on("tick",tick),function(simulation){nodes.call(d3.drag().on("start",(function(event,n){event.active||simulation.alphaTarget(.3).restart(),n.fx=event.x,n.fy=event.y})).on("drag",(function(event,n){n.fx=event.x,n.fy=event.y})).on("end",(function(event){event.active||simulation.alphaTarget(0)})))}(simulation),nodes.on("click",highlightDependencies)})).catch()};var svgWidth,edges,nodes,labels,toggleHighlight=0;function tick(){nodes.attr("cx",(function(n){return n.x})).attr("cy",(function(n){return n.y})),edges.attr("x1",(function(e){return e.source.x})).attr("y1",(function(e){return e.source.y})).attr("x2",(function(e){return e.target.x})).attr("y2",(function(e){return e.target.y})),labels.attr("x",(function(n){return n.x+5})).attr("y",(function(n){return n.y-5})).text((function(n){return n.name}))}function isAncestor(edgeOrNode,node){return node.ancestors.includes(edgeOrNode)}function highlightDependencies(){if(0===toggleHighlight){var d=d3.select(this).data()[0];nodes.style("opacity",(function(o){return isAncestor(o,d)?1:.1})),edges.style("opacity",(function(o){return isAncestor(o,d)?1:.1})),toggleHighlight=1}else nodes.style("opacity",1),edges.style("opacity",1),toggleHighlight=0}}));

//# sourceMappingURL=visualiseDependencies.min.js.map