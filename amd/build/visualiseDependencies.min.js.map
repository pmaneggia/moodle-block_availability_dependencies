{"version":3,"sources":["../src/visualiseDependencies.js"],"names":["init","params","setupSvg","console","log","promises","Ajax","call","methodname","args","courseid","fail","ex","then","dependencies","forEach","d","dep","JSON","parse","simulation","generateSimulation","display","rememberD3Selections","on","tick","makeDraggable","svg","document","querySelector","width","parentNode","clientWidth","height","d3","select","attr","forceSimulation","force","forceManyBody","strength","forceLink","computeEdges","id","forceCenter","filter","name","flatMap","c","x","type","map","target","source","cm","op","displayEdges","links","displayNodesAndLabels","nodes","s_edges","selectAll","data","enter","append","s_nodes","join","edges","labels","n","y","e","text","drag","event","fx","fy","alpha","restart"],"mappings":"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","sourcesContent":["import Ajax from 'core/ajax';\n\nexport const init = (params) => {\n    setupSvg();\n    console.log(params);\n    var promises = Ajax.call([{ \n        methodname: 'block_availability_dependencies_fetch_course_modules_with_names_and_dependencies',\n        args: {courseid: params}\n     }]);\n\n    promises[0].fail(ex => console.log(ex))\n        .then(dependencies => {\n            dependencies.forEach(d => {d.dep = JSON.parse(d.dep)});\n            let simulation = generateSimulation(dependencies);\n            display(simulation);\n            rememberD3Selections();\n            simulation.on('tick', tick);\n            makeDraggable(simulation);\n        });\n};\n\n/**\n * Make the svg as wide as the parent, height is width * 0.6, center viewBox.\n */\nfunction setupSvg() {\n    let svg = document.querySelector('svg');\n    let width = svg.parentNode.clientWidth;\n    let height = width * 0.6;\n    d3.select('svg')\n        .attr('width', width)\n        .attr('height', height)\n        .attr('viewBox', -width/2 + ' ' + -height/2 + ' ' + width + ' ' + height);\n}\n\n/**\n * Generate a simulation, using the nodes and edges (links)\n * extracted from json string representing the dependencies between course modules.\n * The nodes are indexed by the course module id.\n * @param {*} dependencies, modules\n * @returns \n */\nfunction generateSimulation(dependencies) {\n    return d3.forceSimulation(dependencies)\n        .force('charge', d3.forceManyBody().strength(-300))\n        .force('link', d3.forceLink(computeEdges(dependencies)).id(d => d.id))\n        .force('center', d3.forceCenter());\n}\n\n/**\n * Compute the edges (links) for d3-force\n * as an array of objects {source: cm_id, target: cm_id}.\n * 1) filter out all elements with no dependencies;\n * 2) filter out all dependencies that are not type: completion\n * 3) for each remaining produce an edge with source and target, collecting also the operator. \n */ \nfunction computeEdges(dependencies) {\n    return dependencies.filter(({id, name, dep}) => (dep !== null))\n        .flatMap(({id, name, dep}) => {\n            return dep.c.filter(x => x.type == 'completion').map(x => {return {target: id, source: x.cm, op: x.op}})\n        });\n}\n\n/**\n * Use d3 to display nodes and edges (links).\n * The stroke-dasharray distingushes between the operator:\n * '&' (solid) - '|' dotted and all other cases dot-dash \n * @param {*} simulation \n */\nfunction display(simulation) {\n    displayEdges(simulation.force('link').links());\n    displayNodesAndLabels(simulation.nodes());\n}\n\nfunction displayEdges(s_edges) {\n    d3.select('svg g').selectAll('line').data(s_edges)\n        .enter().append('line')\n        .attr('stroke', 'lightgray')\n        .attr('stroke-width', '2px')\n        .attr('stroke-dasharray', x => (x.op == '&' ? '0 0' : (x.op == '|' ? '2 2' : '7 2 2 2')))\n        .attr('marker-end', 'url(#arrow)');\n}\n\nfunction displayNodesAndLabels(s_nodes) {\n    d3.select('svg g').selectAll('circle').data(s_nodes)\n        .join('circle')\n        .attr('fill', '#00a8d5')\n        .attr('stroke', 'white')\n        .attr('r', 5);\n    d3.select('svg g').selectAll('text').data(s_nodes)\n        .join('text')\n        .attr('fill', 'darkgray')\n        .attr('font-family', 'sans-serif')\n        .attr('font-weight', 'bold')\n        .attr('font-size', 'small');\n}\n\nlet edges, nodes, labels;\n\nfunction rememberD3Selections() {\n    edges = d3.select('svg g').selectAll('line');\n    nodes = d3.select('svg g').selectAll('circle');\n    labels = d3.select('svg g').selectAll('text');\n}\n\n/**\n * Update the simulation.\n */\nfunction tick() {\n    nodes\n        .attr('cx', n => n.x)\n        .attr('cy', n => n.y);\n    edges\n        .attr('x1', e => e.source.x)\n        .attr('y1', e => e.source.y)\n        .attr('x2', e => e.target.x)\n        .attr('y2', e => e.target.y);\n    labels\n        .attr('x', n => n.x + 5)\n        .attr('y', n => n.y - 5)\n        .text(n => n.name);\n\n}\n\nfunction makeDraggable(simulation) {\n    nodes\n        .call(d3.drag().on('drag',\n            (event, n) => {\n                n.fx = event.x;\n                n.fy = event.y;\n                simulation.alpha(1).restart();\n            }))\n}\n\n"],"file":"visualiseDependencies.min.js"}