{"version":3,"sources":["../src/visualiseDependencies.js"],"names":["init","courseid","full","promises","Ajax","call","methodname","args","fail","ex","console","log","then","dependencies","dimensions","determineSvgSize","setupSvg","forEach","d","depend","JSON","parse","simulation","generateSimplifiedSimulation","displaySimplifiedGraph","generateFullSimulation","displayFullGraph","rememberD3Selections","on","tick","makeDraggable","d3","select","attr","width","height","addMarker","append","svg","document","querySelector","parentNode","clientWidth","forceSimulation","force","forceX","forceY","forceManyBody","strength","forceLink","computeEdgesSimplifiedDependencies","distance","id","computeEdgesFullDependencies","leaves","c","flatMap","op","type","cm","filter","name","predecessor","map","target","source","flat","displaySimplifiedEdges","links","displaySimplifiedNodesAndLabels","nodes","displayFullEdges","displayFullNodesAndLabels","s_edges","selectAll","data","enter","s_nodes","join","clone","lower","edges","labels","n","x","y","e","text","drag","event","active","alphaTarget","restart","fx","fy"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Visualise dependencies.\n *\n * @copyright  2022 Paola Maneggia, Mathias Kegelmann\n * @author     Paola Maneggia <paola.maneggia@gmail.com>, Mathias Kegelmann <mathias.kegelmann@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @module     block/availability_dependencies\n */\n\nimport Ajax from 'core/ajax';\n\nconst full = 'no';\n\nexport const init = (courseid, full) => {\n    full = full;\n    var promises = Ajax.call([{\n        methodname: 'block_availability_dependencies_fetch_course_modules_with_names_and_dependencies',\n        args: {courseid: courseid}\n    }\n]);\n\npromises[0].fail(ex => console.log(ex))\n    .then(dependencies => {\n        let dimensions = determineSvgSize();\n        setupSvg(dimensions);\n        dependencies.forEach(d => {d.depend = JSON.parse(d.depend)});\n        let simulation;\n        if (full === 'no') {\n            simulation = generateSimplifiedSimulation(dependencies, dimensions);\n            displaySimplifiedGraph(simulation);\n        } else {\n            simulation = generateFullSimulation(dependencies);\n            displayFullGraph(simulation);\n        }\n        rememberD3Selections();\n        simulation.on('tick', tick);\n        makeDraggable(simulation);\n    });\n};\n\n/**\n * Make the svg as wide as the parent, height is width * 0.6, center viewBox.\n */\nfunction setupSvg(dimensions) {\n    d3.select('svg.availability_dependencies')\n        .attr('width', dimensions.width)\n        .attr('height', dimensions.height)\n        .attr('viewBox', -dimensions.width/2 + ' ' + -dimensions.height/2\n            + ' ' + dimensions.width + ' ' + dimensions.height);\n    addMarker();\n}\n\nfunction addMarker() { // TODO differentiate between simplifies and full\n    d3.select('svg.availability_dependencies').select('g').append('defs').append('marker')\n      .attr('id', 'arrow')\n      .attr('viewBox', \"0 0 10 10\")\n      .attr('refX', 13.5)\n      .attr('refY', 5)\n      .attr('markerUnits', 'strokeWidth')\n      .attr('markerWidth', 6)\n      .attr('markerHeight', 8)\n      .attr('orient', 'auto')\n    .append('path')\n      .attr('fill', 'lightgray')\n      .attr('d', 'M 0 0 L 10 5 L 0 10 z');\n}\n\nfunction determineSvgSize() {\n    let svg = document.querySelector('svg.availability_dependencies');\n    let width = svg.parentNode.clientWidth;\n    let height = width * 0.6;\n    return {width, height};\n}\n\n/**\n * Generate a simulation, using the nodes and edges (links)\n * extracted from json string representing the dependencies between course modules.\n * The nodes are indexed by the course module id.\n * @param {json} dependencies\n * @returns d3 simulation object\n */\nfunction generateSimulation(dependencies) {\n    return d3.forceSimulation(dependencies)\n        .force('x0', d3.forceX())\n        .force('y0', d3.forceY())\n        .force('charge', d3.forceManyBody().strength(-300))\n        .force('link', d3.forceLink(computeEdges(dependencies)).distance(80).id(d => d.id));\n}\n\nfunction generateSimplifiedSimulation(dependencies, dimensions) {\n    return d3.forceSimulation(dependencies)\n        .force('x0', d3.forceX())\n        .force('y0', d3.forceY())\n        .force('charge', d3.forceManyBody().strength(-300))\n        .force('link', d3.forceLink(computeEdgesSimplifiedDependencies(dependencies)).distance(80).id(d => d.id));\n}\n\nfunction generateFullSimulation(dependencies) {\n    return d3.forceSimulation(dependencies)\n        .force('x0', d3.forceX())\n        .force('y0', d3.forceY())\n        .force('charge', d3.forceManyBody().strength(-300))\n        .force('link', d3.forceLink(computeEdgesFullDependencies(dependencies)).distance(80).id(d => d.id));\n}\n\n/**\n * For a simplified representation, flatten any nesting.\n * @param {} dependencies \n */\nfunction computeEdgesSimplifiedDependencies(dependencies) {\n    // for an array of nested dependencies\n    // extract all the cm.id of leaves of type 'completion'\n    let leaves = (depend =>\n        depend.c.flatMap(d => d.op ? leaves(d) : (d.type === 'completion' ? d.cm : [])));\n    return dependencies\n        .filter(({id, name, depend, predecessor}) => (depend !== null))\n        .map(({id, name, depend, predecessor}) => \n            leaves(depend).map(cm => {return {\n                target: id,\n                source: cm === -1 ? predecessor : cm,\n                name: name\n            }}))\n        .flat();\n}\n\n/**\n * For a full representation, generate a node for each leaf (condition without any further\n * nesting and for each operator. For each completion of an activity there is a flag 'e' which\n * can have value 0, 1, 2 or 3 meaning. Add a done with that flag between the activity and the next\n * node.\n * @param {} dependencies \n */\n function computeEdgesFullDependencies(dependencies) { //TODO implement - for the moment is a copy of simplified\n    // for an array of nested dependencies\n    // extract all the cm.id of leaves of type 'completion'\n    let leaves = (depend =>\n        depend.c.flatMap(d => d.op ? leaves(d) : (d.type === 'completion' ? d.cm : [])));\n    return dependencies\n        .filter(({id, name, depend, predecessor}) => (depend !== null))\n        .map(({id, name, depend, predecessor}) => \n            leaves(depend).map(cm => {return {\n                target: id,\n                source: cm === -1 ? predecessor : cm,\n                name: name\n            }}))\n        .flat();\n}\n\n/**\n * Compute the edges (links) for d3-force\n * as an array of objects {source: cm_id, target: cm_id}.\n * 1) filter out all elements with no dependencies;\n * 2) filter out all dependencies that are not type: completion\n * 3) for each remaining produce an edge with source and target, collecting also the operator.\n * If the type of availability was based on the completion of the previous activity with completion\n * update the value of the cm with the correct id instead of -1.\n * 4) the operator is changed to 'negLit' if the literal is negated i.e. depend.c.e is 0 (activity must not be completed) \n */ \nfunction computeEdges(dependencies) {\n    return dependencies.filter(({id, name, depend, predecessor}) => (depend !== null))\n        .flatMap(({id, name, depend, predecessor}) => {\n            return depend.c.filter(x => x.type == 'completion')\n                .map(x => {return {\n                    target: id, \n                    source: x.cm == -1 ? predecessor : x.cm, \n                    op: x.e ? depend.op : 'negLit'\n                }})\n        });\n}\n\n/**\n * Use d3 to display nodes and edges (links).\n * @param simulation\n */\nfunction displayGraph(simulation) {\n    displayEdges(simulation.force('link').links());\n    displayNodesAndLabels(simulation.nodes());\n}\n\n/**\n * Use d3 to display nodes and edges (links).\n * @param simulation\n */\n function displaySimplifiedGraph(simulation) {\n    displaySimplifiedEdges(simulation.force('link').links());\n    displaySimplifiedNodesAndLabels(simulation.nodes());\n}\n\n/**\n * Use d3 to display nodes and edges (links).\n * @param simulation\n */\n function displayFullGraph(simulation) {\n    displayFullEdges(simulation.force('link').links());\n    displayFullNodesAndLabels(simulation.nodes());\n}\n\n/**\n * Add the graphical elements to display the edges.\n * The stroke-dasharray distingushes between the operator:\n * '&' (solid) - '|' dotted and all other cases dashdotted.\n * @param s_edges Edges (links) in the d3 simulation.\n */\nfunction displayEdges(s_edges) {\n    d3.select('svg').select('g').append('g').selectAll('line').data(s_edges)\n        .enter().append('line')\n        .attr('stroke', 'lightgray')\n        .attr('stroke-width', '2px')\n        .attr(\"stroke-linecap\", \"round\")\n        .attr('stroke-dasharray', x => (x.op == '&' ? '0 0' : (x.op == '|' ? '1 4' : '9 4 1 4')))\n        .attr('marker-end', 'url(#arrow)');\n}\n\n/**\n * Add the graphical elements to display the edges.\n * The stroke-dasharray distingushes between the operator:\n * '&' (solid) - '|' dotted and all other cases dashdotted.\n * @param s_edges Edges (links) in the d3 simulation.\n */\n function displaySimplifiedEdges(s_edges) {\n    d3.select('svg').select('g').append('g').selectAll('line').data(s_edges)\n        .enter().append('line')\n        .attr('stroke', 'lightgray')\n        .attr('stroke-width', '2px')\n        .attr(\"stroke-linecap\", \"round\")\n        .attr('marker-end', 'url(#arrow)');\n}\n\n/**\n * Add the graphical elements to display the edges.\n * The stroke-dasharray distingushes between the operator:\n * '&' (solid) - '|' dotted and all other cases dashdotted.\n * @param s_edges Edges (links) in the d3 simulation.\n */\n function displayFullEdges(s_edges) {\n    d3.select('svg').select('g').append('g').selectAll('line').data(s_edges)\n        .enter().append('line')\n        .attr('stroke', 'lightgray')\n        .attr('stroke-width', '2px')\n        .attr(\"stroke-linecap\", \"round\")\n        .attr('marker-end', 'url(#arrow)');\n}\n\n/**\n * Add the graphical elements to display the nodes and labels.\n * @param s_nodes Nodes in the d3 simulation.\n */\nfunction displayNodesAndLabels(s_nodes) {\n    d3.select('svg').select('g').append('g').selectAll('circle').data(s_nodes)\n        .join('circle')\n        .attr('fill', '#00a8d5')\n        .attr('stroke', 'white')\n        .attr('r', 5);\n    d3.select('svg').select('g').append('g').selectAll('text').data(s_nodes)\n        .join('text')\n        .attr('fill', 'darkgray')\n        .attr('font-family', 'sans-serif')\n        .attr('font-weight', 'bold')\n        .attr('font-size', 'small')\n      .clone().lower()\n        .attr('stroke', 'white')\n        .attr('stroke-width', 4)\n        .attr('stroke-opacity', 0.5);\n}\n\n/**\n * Add the graphical elements to display the nodes and labels.\n * @param s_nodes Nodes in the d3 simulation.\n */\n function displaySimplifiedNodesAndLabels(s_nodes) {\n    d3.select('svg').select('g').append('g').selectAll('circle').data(s_nodes)\n        .join('circle')\n        .attr('fill', '#00a8d5')\n        .attr('stroke', 'white')\n        .attr('r', 5);\n    d3.select('svg').select('g').append('g').selectAll('text').data(s_nodes)\n        .join('text')\n        .attr('fill', 'darkgray')\n        .attr('font-family', 'sans-serif')\n        .attr('font-weight', 'bold')\n        .attr('font-size', 'small')\n      .clone().lower()\n        .attr('stroke', 'white')\n        .attr('stroke-width', 4)\n        .attr('stroke-opacity', 0.5);\n}\n\n/**\n * Add the graphical elements to display the nodes and labels.\n * @param s_nodes Nodes in the d3 simulation.\n */\n function displayFullNodesAndLabels(s_nodes) {\n    d3.select('svg').select('g').append('g').selectAll('circle').data(s_nodes)\n        .join('circle')\n        .attr('fill', '#00a8d5')\n        .attr('stroke', 'white')\n        .attr('r', 30);\n    d3.select('svg').select('g').append('g').selectAll('text').data(s_nodes)\n        .join('text')\n        .attr('fill', 'darkgray')\n        .attr('font-family', 'sans-serif')\n        .attr('font-weight', 'bold')\n        .attr('font-size', 'small')\n      .clone().lower()\n        .attr('stroke', 'white')\n        .attr('stroke-width', 4)\n        .attr('stroke-opacity', 0.5);\n}\n\nlet edges, nodes, labels;\n\n/**\n * Save the graphical representation of edges, nodes and labals.\n */\nfunction rememberD3Selections() {\n    edges = d3.select('svg g').selectAll('line');\n    nodes = d3.select('svg g').selectAll('circle');\n    labels = d3.select('svg g').selectAll('text');\n}\n\n/**\n * Update the simulation.\n */\nfunction tick() {\n    nodes\n        .attr('cx', n => n.x)\n        .attr('cy', n => n.y);\n    edges\n        .attr('x1', e => e.source.x)\n        .attr('y1', e => e.source.y)\n        .attr('x2', e => e.target.x)\n        .attr('y2', e => e.target.y);\n    labels\n        .attr('x', n => n.x + 5)\n        .attr('y', n => n.y - 5)\n        .text(n => n.name);\n\n}\n\n/**\n * Make nodes draggable.\n * Once dragged a node is fixed to its assigned position in the simulation.\n * @param simulation\n */\nfunction makeDraggable(simulation) {\n    nodes\n        .call(d3.drag()\n        .on('start', (event, n) => {\n            if (!event.active) simulation.alphaTarget(0.3).restart();\n            n.fx = event.x;\n            n.fy = event.y;\n        })\n        .on('drag',\n            (event, n) => {\n                n.fx = event.x;\n                n.fy = event.y;\n            })\n        .on('end', (event) => {if (!event.active) simulation.alphaTarget(0);})\n        );\n}\n\n"],"file":"visualiseDependencies.min.js"}