{"version":3,"sources":["../src/visualiseDependencies.js"],"names":["init","courseid","full","promises","Ajax","call","methodname","args","fail","ex","console","log","then","dependencies","dimensions","determineSvgSize","setupSvg","forEach","d","depend","JSON","parse","simulation","generateSimplifiedSimulation","displaySimplifiedGraph","generateFullSimulation","displayFullGraph","rememberD3Selections","storeAncestorEdgesAndNodesInAllNodes","edges","on","tick","makeDraggable","makeDoubleClickable","toggleHighlight","nodeColour","textColour","arrowColour","fullNodeRadius","operatorRadius","arrowWidth","svgWidth","d3","select","attr","width","height","addMarker","addFilterDropShadow","dev","append","svg","document","querySelector","parentNode","clientWidth","orientation","screen","type","forceSimulation","force","forceX","forceY","forceCollide","radius","forceManyBody","strength","forceLink","computeEdgesSimplifiedDependencies","distance","id","computeEdgesAndNodesFullDependencies","nodes","n","isSource","isTarget","genus","leaves","c","flatMap","op","cm","filter","name","predecessor","map","target","source","flat","onlyNonCompletionConditionsIn","dependList","length","uid","getNextUID","extractEdgesAndNodes","toGenus","el","newNode","push","newEdge","e","sn","find","newEdgeFromNot","newEdgeToNot","a","displaySimplifiedEdges","links","displaySimplifiedNodesAndLabels","s_edges","selectAll","data","enter","displayFullEdges","displayFullNodesAndLabels","s_nodes","join","clone","lower","labels","x","y","text","drag","event","active","alphaTarget","restart","fx","fy","highlightDependencies","allEdges","computeAndStoreAncestorEdgesAndNodes","node","aNodes","Set","aEdges","toBeExaminedNodes","currentNode","shift","add","ed","has","ancestors","concat","isAncestor","edgeOrNode","includes","style","o"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Visualise dependencies.\n *\n * @copyright  2022 Paola Maneggia, Mathias Kegelmann\n * @author     Paola Maneggia <paola.maneggia@gmail.com>, Mathias Kegelmann <mathias.kegelmann@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @module     block/availability_dependencies\n */\n\nimport Ajax from 'core/ajax';\n\nconst full = 'no';\n\nexport const init = (courseid, full) => {\n    full = full;\n    var promises = Ajax.call([{\n        methodname: 'block_availability_dependencies_fetch_course_modules_with_names_and_dependencies',\n        args: {courseid: courseid}\n    }\n]);\n\npromises[0].fail(ex => console.log(ex))\n    .then(dependencies => {\n        let dimensions = determineSvgSize();\n        setupSvg(dimensions);\n        dependencies.forEach(d => {d.depend = JSON.parse(d.depend)});\n        let simulation;\n        let hierarchies;\n        if (full === 'no') {\n            simulation = generateSimplifiedSimulation(dependencies);\n            displaySimplifiedGraph(simulation);\n        } else {\n            simulation = generateFullSimulation(dependencies);\n            displayFullGraph(simulation);\n        }\n        rememberD3Selections();\n        storeAncestorEdgesAndNodesInAllNodes(edges);\n        simulation.on('tick', tick);\n        makeDraggable(simulation);\n        makeDoubleClickable(simulation);\n    });\n};\n\nlet toggleHighlight = 0;\n\nlet nodeColour = '#AEDAEA';\nlet textColour = '#364958';\nlet arrowColour = '#516E84';\nlet andColour = '#FFB400';\nlet orColour = '#CEFF1A';\nlet notAndColour = '#F9CFF2';\nlet notOrColour = '#D1FAFF';\nlet otherOperatorColour = '#D1FAFF';\nlet notColour = '#EA7B5D';\n\nlet fullNodeRadius = 50;\nlet operatorRadius = 20;\n\nlet arrowWidth = 2;\n\nlet svgWidth;\nlet svgHeight;\n\n/**\n * Make the svg as wide as the parent, height is width * 0.6, center viewBox.\n */\nfunction setupSvg(dimensions) {\n    d3.select('svg.availability_dependencies')\n        .attr('width', dimensions.width)\n        .attr('height', dimensions.height)\n        .attr('viewBox', -dimensions.width/2 + ' ' + -dimensions.height/2\n            + ' ' + dimensions.width + ' ' + dimensions.height);\n    addMarker();\n    addFilterDropShadow();\n}\n\nfunction addMarker() {\n    let dev = d3.select('g.availability_dependencies').append('defs');\n    dev.append('marker')\n      .attr('id', 'arrow')\n      .attr('viewBox', \"0 0 10 10\")\n      .attr('refX', 23)\n      .attr('refY', 5)\n      .attr('markerUnits', 'strokeWidth')\n      .attr('markerWidth', 6)\n      .attr('markerHeight', 8)\n      .attr('orient', 'auto')\n    .append('path')\n      .attr('fill', arrowColour)\n      .attr('d', 'M 0 0 L 10 5 L 0 10 z');\n    \n    dev.append('marker')\n      .attr('id', 'arrowToActivity')\n      .attr('viewBox', \"0 0 10 10\")\n      .attr('refX', 52)\n      .attr('refY', 5)\n      .attr('markerUnits', 'strokeWidth')\n      .attr('markerWidth', 6)\n      .attr('markerHeight', 8)\n      .attr('orient', 'auto')\n    .append('path')\n      .attr('fill', arrowColour)\n      .attr('d', 'M 0 0 L 10 5 L 0 10 z');\n\n    dev.append('marker')\n      .attr('id', 'arrowToOperator')\n      .attr('viewBox', \"0 0 10 10\")\n      .attr('refX', 27)\n      .attr('refY', 5)\n      .attr('markerUnits', 'strokeWidth')\n      .attr('markerWidth', 6)\n      .attr('markerHeight', 8)\n      .attr('orient', 'auto')\n    .append('path')\n      .attr('fill', arrowColour)\n      .attr('d', 'M 0 0 L 10 5 L 0 10 z');\n}\n\nfunction addFilterDropShadow() {\n    let dev = d3.select('g.availability_dependencies defs');\n    dev.append('filter')\n      .attr('id', 'textShadow')\n    .append('feDropShadow')\n      .attr('dx', 0)\n      .attr('dy', 0)\n      .attr('stdDeviation', 2)\n      .attr('flood-color', 'white')\n      .attr('flood-opacity', 1)\n}\n\nfunction determineSvgSize() {\n    let svg = document.querySelector('svg.availability_dependencies');\n    let width = svg.parentNode.clientWidth;\n    let orientation = screen.orientation?.type;\n    let height = orientation === \"portrait-primary\" ? width * 1.3 : width * 0.6;\n    svgWidth = width;\n    svgHeight = height;\n    return {width, height};\n}\n\n/**\n * Generate a simulation, using the nodes and edges (links)\n * extracted from the dependencies between course modules.\n * The nodes are indexed by the course module id.\n * @param {json} dependencies\n * @returns d3 simulation object\n */\nfunction generateSimplifiedSimulation(dependencies) {\n    return d3.forceSimulation(dependencies)\n        .force('x0', d3.forceX())\n        .force('y0', d3.forceY())\n        .force('collide', d3.forceCollide().radius(20))\n        .force('charge', d3.forceManyBody().strength(-300))\n        .force('link', d3.forceLink(computeEdgesSimplifiedDependencies(dependencies)).distance(200).id(d => d.id));\n}\n\n/**\n * Generate a simulation, using the nodes and edges (links)\n * extracted from the dependencies between course modules.\n * The activity nodes are indexed by the course module id,\n * the operator nodes are indexed by a generated unique id.\n * @param dependencies Array of objects with fields {id, name, depend, predecessor}\n * @returns d3 simulation object\n */\nfunction generateFullSimulation(dependencies) {\n    let {edges, nodes} = computeEdgesAndNodesFullDependencies(dependencies);\n    return d3.forceSimulation(nodes)\n        .force('x0', d3.forceX())\n        .force('y0', d3.forceY())\n        .force('isSource', d3.forceX(-svgWidth/3).strength(n => n.isSource))\n        .force('isTarget', d3.forceX(svgWidth/3).strength(n => n.isTarget))\n        .force('collide', d3.forceCollide(100).radius(n => (n.genus === 'activity' ? fullNodeRadius : operatorRadius) + 30))\n        .force('charge', d3.forceManyBody().strength(-300))\n        .force('link', d3.forceLink(edges).distance(50).id(d => d.id));\n}\n\n/**\n * For a simplified representation, flatten any nesting.\n * @param {} dependencies \n */\nfunction computeEdgesSimplifiedDependencies(dependencies) {\n    // for an array of nested dependencies\n    // extract all the cm.id of leaves of type 'completion'\n    let leaves = (depend => // TODO fix small bug here d.op && !d.type\n        depend.c.flatMap(d => d.op ? leaves(d) : (d.type === 'completion' ? d.cm : [])));\n    return dependencies\n        .filter(({id, name, depend, predecessor}) => (depend !== null))\n        .map(({id, name, depend, predecessor}) => \n            leaves(depend).map(cm => {return {\n                target: id,\n                source: cm === -1 ? predecessor : cm,\n                name: name\n            }}))\n        .flat();\n}\n\n/**\n * For a full representation we need nodes for the operators besides the nodes\n * representing the activities. For each node we use fields id, name, genus (activity or operator),\n * isSource and isTarget (the last two are for the layout - sort of extenden fuzzy logic,\n * they are a quantity instead of a boolean).\n * An activity node has as id its course module id and as name its name.\n * An operator node has as id the a uniquely generated id.\n * \n * For each completion of an activity there is a flag 'e' which\n * can have value 0, 1, 2 or 3 (meaning: activity (0) should not be completed; (1) must be completed;\n * (2) must be completed an passed; (3) must be completed and failed).\n * TODO Add a node with that flag between the activity and the previous node.\n * @param {} dependencies \n */\nfunction computeEdgesAndNodesFullDependencies(dependencies) {\n\n    function onlyNonCompletionConditionsIn(dependList) {\n        return dependList.filter(c => (c.type && c.type == 'completion' || (!c.type && c.op))).length === 0;\n    }\n    \n    let uid = 0;\n\n    function getNextUID() {\n        return 'uid_' + uid++;\n    }\n\n    function extractActivityNodes(dependencies) {\n        return dependencies.map(d => {\n            return {\n                id: d.id,\n                name: d.name,\n                genus: 'activity',\n                isSource: 0,\n                isTarget: 0,\n            }\n        });\n    }\n\n    let edges = [];\n    let nodes = extractActivityNodes(dependencies);\n\n    // id is the id field of the target node, of genus 'operator' after the first call.\n    // toGenus: genus of the target node ('activity' or 'operator')\n    // dependList the list of dependencies that have the node with id id as target\n    // predecessor is the cmid of the activity node for which we are extracting the information,\n    // to be used if in the nesting of dependencies there will be one with {type: 'completion', cm:-1}\n    // An edge has the same genus as its target.\n    function extractEdgesAndNodes(id, toGenus, dependList, predecessor) {\n        dependList.forEach(el => {\n            if (!el.type && el.op && !onlyNonCompletionConditionsIn(el.c)) {\n                // generate node\n                let newNode = {\n                    id: getNextUID(),\n                    name: el.op,\n                    genus: 'operator',\n                    isTarget: 0.1,\n                    isSource: 0.1\n                };\n                nodes.push(newNode);\n                // generate edge\n                let newEdge = {\n                    target: id,\n                    source: newNode.id,\n                    toGenus: toGenus\n                };\n                edges.push(newEdge);\n                //recursive call\n                extractEdgesAndNodes(newNode.id, 'operator', el.c, predecessor);\n            } else if (el.type === 'completion' && el.e > 0) {\n                // generate edge\n                let newEdge = {\n                    target: id,\n                    source: el.cm === -1 ? predecessor : el.cm,\n                    toGenus: toGenus\n                };\n                // increase isSource of the source node to a max of 1.5\n                let sn = nodes.find(n => n.id === newEdge.source);\n                sn.isSource = (sn.isSource + 0.6 > 1.5 ? 1.5 : sn.isSource + 0.6);\n                edges.push(newEdge);\n            } else if (el.type === 'completion' && el.e === 0){\n                // connect with two edges a 'not' node in between\n                let newNode = {\n                    id: getNextUID(),\n                    name: 'not',\n                    genus: 'operator',\n                    isTarget: 0.1,\n                    isSource: 0.1\n                };\n                let newEdgeFromNot = {\n                    target: id,\n                    source: newNode.id,\n                    toGenus: toGenus\n                };\n                let newEdgeToNot = {\n                    target: newNode.id,\n                    source: el.cm === -1 ? predecessor : el.cm,\n                    toGenus: 'operator'\n                }\n                nodes.push(newNode);\n                edges.push(newEdgeFromNot);\n                edges.push(newEdgeToNot);\n                // increase isSource of the source node to a max of 1.5\n                let sn = nodes.find(n => n.id === newEdgeToNot.source);\n                sn.isSource = (sn.isSource + 0.6 > 1.5 ? 1.5 : sn.isSource + 0.6);\n            }\n        })\n    }\n\n    dependencies.forEach(a => {\n        if(a.depend !== null) {\n            // If an activity has some availability conditions, set the value for isTarget in its node.\n            // For the moment I am not checking if the conditions are of the wrong type\n            nodes.find(n => n.id === a.id).isTarget = 0.9;\n            extractEdgesAndNodes(a.id, 'activity', [a.depend], a.predecessor)\n        }\n    });\n\n    return {edges, nodes};\n}\n\n/**\n * Use d3 to display nodes and edges (links).\n * @param simulation\n */\nfunction displaySimplifiedGraph(simulation) {\n    displaySimplifiedEdges(simulation.force('link').links());\n    displaySimplifiedNodesAndLabels(simulation.nodes());\n}\n\n/**\n * Add the graphical elements to display the edges.\n * @param s_edges Edges (links) in the d3 simulation.\n */\n function displaySimplifiedEdges(s_edges) {\n    d3.select('g.availability_dependencies').append('g').selectAll('line').data(s_edges)\n        .enter().append('line')\n        .attr('stroke', arrowColour)\n        .attr('stroke-width', arrowWidth + 'px')\n        .attr(\"stroke-linecap\", \"round\")\n        .attr('marker-end', 'url(#arrow)');\n}\n\n/**\n * Use d3 to display nodes and edges (links).\n * @param simulation\n */\n function displayFullGraph(simulation) {\n    displayFullEdges(simulation.force('link').links());\n    displayFullNodesAndLabels(simulation.nodes());\n}\n\n/**\n * Add the graphical elements to display the edges.\n * @param s_edges Edges (links) in the d3 simulation.\n */\nfunction displayFullEdges(s_edges) {\n    d3.select('g.availability_dependencies').append('g').selectAll('line').data(s_edges)\n        .enter().append('line')\n        .attr('stroke', textColour)\n        .attr('stroke-opacity', 0.7)\n        .attr('stroke-width', arrowWidth + 'px')\n        .attr(\"stroke-linecap\", \"round\")\n        .attr('marker-end', e => e.toGenus === 'activity' ?\n            'url(#arrowToActivity' :\n            'url(#arrowToOperator');\n}\n\n/**\n * Add the graphical elements to display the nodes and labels.\n * @param s_nodes Nodes in the d3 simulation.\n */\n function displaySimplifiedNodesAndLabels(s_nodes) {\n    d3.select('g.availability_dependencies').append('g').selectAll('circle').data(s_nodes)\n        .join('circle')\n        .attr('fill', nodeColour)\n        .attr('stroke', 'white')\n        .attr('r', 16);\n    d3.select('g.availability_dependencies').append('g').selectAll('text').data(s_nodes)\n        .join('text')\n        .attr('fill', textColour)\n        .attr('font-family', 'sans-serif')\n        .attr('font-weight', 'bold')\n      .clone().lower()\n        .attr('stroke', 'white')\n        .attr('stroke-width', 4)\n        .attr('stroke-opacity', 0.5);\n}\n\n/**\n * Add the graphical elements to display the nodes and labels.\n * @param s_nodes Nodes in the d3 simulation.\n */\n function displayFullNodesAndLabels(s_nodes) {\n    d3.select('g.availability_dependencies').append('g').selectAll('circle').data(s_nodes)\n        .join('circle')\n        .attr('fill', n => n.genus === 'activity' ? nodeColour\n            : n.name === '&' ? andColour\n            : n.name === '|' ? orColour\n            : n.name === '!&' ? notAndColour\n            : n.name === '!|' ? notOrColour\n            : n.name === 'not' ? notColour\n            : otherOperatorColour)\n        .attr('stroke', 'white')\n        .attr('stroke-width', 3)\n        .attr('r', n => n.genus === 'activity' ? fullNodeRadius : operatorRadius);\n    d3.select('g.availability_dependencies').append('g').selectAll('text').data(s_nodes)\n        .join('text')\n        .attr('fill', textColour)\n        .attr('font-family', 'sans-serif')\n        .attr('font-weight', 'bold')\n        .attr('text-anchor', 'middle')\n        .attr('dx', -5)\n        .attr('dominant-baseline', 'middle')\n        .attr('dy', 5)\n        .attr('filter', 'url(#textShadow)');\n}\n\nlet edges, nodes, labels;\n\n/**\n * Save the graphical representation of edges, nodes and labals.\n */\nfunction rememberD3Selections() {\n    edges = d3.select('g.availability_dependencies').selectAll('line');\n    nodes = d3.select('g.availability_dependencies').selectAll('circle');\n    labels = d3.select('g.availability_dependencies').selectAll('text');\n}\n\n/**\n * Update the simulation.\n */\nfunction tick() {\n    nodes\n        .attr('cx', n => n.x)\n        .attr('cy', n => n.y);\n    edges\n        .attr('x1', e => e.source.x)\n        .attr('y1', e => e.source.y)\n        .attr('x2', e => e.target.x)\n        .attr('y2', e => e.target.y);\n    labels\n        .attr('x', n => n.x + 5)\n        .attr('y', n => n.y - 5)\n        .text(n => n.name);\n\n}\n\n/**\n * Make nodes draggable.\n * Once dragged a node is fixed to its assigned position in the simulation.\n * @param simulation\n */\nfunction makeDraggable(simulation) {\n    nodes\n        .call(d3.drag()\n        .on('start', (event, n) => {\n            if (!event.active) simulation.alphaTarget(0.3).restart();\n            n.fx = event.x;\n            n.fy = event.y;\n        })\n        .on('drag',\n            (event, n) => {\n                n.fx = event.x;\n                n.fy = event.y;\n            })\n        .on('end', (event) => {if (!event.active) simulation.alphaTarget(0);})\n        );\n}\n\nfunction makeDoubleClickable(simulation) {\n    nodes.on('click', highlightDependencies);\n}\n\n/**\n * Stores ancestors of each node as an additional property.\n * We need this for the highlight function.\n * @returns array of objects\n */\nfunction storeAncestorEdgesAndNodesInAllNodes(allEdges) {\n    return nodes.data().forEach(n => computeAndStoreAncestorEdgesAndNodes(n, allEdges));\n}\n\n/**\n * Compute the ancestor edges and nodes for a given node and stores then in an\n * additional property 'ancestors' of the node.\n * Even if it would be logically absurd to build a cycle in the directed graph of dependencies,\n * there is no guarantee that this does not happen. Moreover a cycle per se does not mean that\n * some activites are unreachable, since they can be negated.\n * @param {*} node a d3 (circle) node from a selection \n */\nfunction computeAndStoreAncestorEdgesAndNodes(node, allEdges) {\n    let aNodes = new Set();\n    let aEdges = new Set();\n    let toBeExaminedNodes = [node];\n    while (toBeExaminedNodes.length) {\n        // each time one element of the queue of nodes to be examined is moved to the set aNodes\n        let currentNode = toBeExaminedNodes.shift();\n        aNodes.add(currentNode);\n        // iterate over the edges and look for the ones that have the current node as target\n        allEdges.data().forEach(ed => {\n            if (ed.target.id === currentNode.id) {\n                aEdges.add(ed);\n                if (!aNodes.has(ed.source)) {\n                    toBeExaminedNodes.push(ed.source);\n                }\n            }\n        })\n    } \n    node.ancestors = [...aNodes].concat([...aEdges]);\n}\n\n/**\n * Check if an edge is ancestor of node\n * @param {*} edgeOrNode the edge or node to check\n * @param {*} node\n * @return the list of ancestor nodes\n */\nfunction isAncestor(edgeOrNode, node) {\n    return node.ancestors.includes(edgeOrNode);\n}\n\nfunction highlightDependencies() {\n    if (toggleHighlight === 0) {\n        // Reduce the opacity of all but the ancestor nodes\n        let d = d3.select(this).data()[0];\n        nodes.style(\"opacity\", function (o) {\n            return isAncestor(o, d) ? 1 : 0.1;\n        });\n        edges.style(\"opacity\", function (o) {\n            return isAncestor(o, d) ? 1 : 0.1;\n        });\n        // mark hightlighting as on\n        toggleHighlight = 1;\n    } else {\n        // Put opacity back to 1 for all nodes and links\n        nodes.style(\"opacity\", 1);\n        edges.style(\"opacity\", 1);\n        // mark highlighting as off\n        toggleHighlight = 0;\n    }\n}\n"],"file":"visualiseDependencies.min.js"}