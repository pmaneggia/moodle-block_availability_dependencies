{"version":3,"sources":["../src/visualiseDependencies.js"],"names":["init","params","promises","Ajax","call","methodname","args","courseid","fail","ex","console","log","then","dependencies","dimensions","determineSvgSize","setupSvg","forEach","d","dep","JSON","parse","simulation","generateSimulation","displayGraph","rememberD3Selections","on","tick","makeDraggable","d3","select","attr","width","height","addMarker","append","svg","document","querySelector","parentNode","clientWidth","forceSimulation","force","forceX","forceY","forceManyBody","strength","forceLink","computeEdges","distance","id","filter","name","flatMap","c","x","type","map","target","source","cm","op","e","displayEdges","links","displayNodesAndLabels","nodes","s_edges","selectAll","data","enter","s_nodes","join","clone","lower","edges","labels","n","y","text","drag","event","active","alphaTarget","restart","fx","fy"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Visualise dependencies.\n *\n * @copyright  2022 Paola Maneggia, Mathias Kegelmann\n * @author     Paola Maneggia <paola.maneggia@gmail.com>, Mathias Kegelmann <mathias.kegelmann@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @module     block/availability_dependencies\n */\n\nimport Ajax from 'core/ajax';\n\nexport const init = (params) => {\n    var promises = Ajax.call([{\n        methodname: 'block_availability_dependencies_fetch_course_modules_with_names_and_dependencies',\n        args: {courseid: params}\n    }]);\n\n    promises[0].fail(ex => console.log(ex))\n        .then(dependencies => {\n            let dimensions = determineSvgSize();\n            setupSvg(dimensions);\n            dependencies.forEach(d => {d.dep = JSON.parse(d.dep)});\n            let simulation = generateSimulation(dependencies);\n            displayGraph(simulation);\n            rememberD3Selections();\n            simulation.on('tick', tick);\n            makeDraggable(simulation);\n        });\n};\n\n/**\n * Make the svg as wide as the parent, height is width * 0.6, center viewBox.\n */\nfunction setupSvg(dimensions) {\n    d3.select('svg.availability_dependencies')\n        .attr('width', dimensions.width)\n        .attr('height', dimensions.height)\n        .attr('viewBox', -dimensions.width/2 + ' ' + -dimensions.height/2\n            + ' ' + dimensions.width + ' ' + dimensions.height);\n    addMarker();\n}\n\nfunction addMarker() {\n    d3.select('svg.availability_dependencies').select('g').append('defs').append('marker')\n      .attr('id', 'arrow')\n      .attr('viewBox', \"0 0 10 10\")\n      .attr('refX', 13.5)\n      .attr('refY', 5)\n      .attr('markerUnits', 'strokeWidth')\n      .attr('markerWidth', 6)\n      .attr('markerHeight', 8)\n      .attr('orient', 'auto')\n    .append('path')\n      .attr('fill', 'lightgray')\n      .attr('d', 'M 0 0 L 10 5 L 0 10 z');\n}\n\nfunction determineSvgSize() {\n    let svg = document.querySelector('svg.availability_dependencies');\n    let width = svg.parentNode.clientWidth;\n    let height = width * 0.6;\n    return {width, height};\n}\n\n/**\n * Generate a simulation, using the nodes and edges (links)\n * extracted from json string representing the dependencies between course modules.\n * The nodes are indexed by the course module id.\n * @param {json} dependencies\n * @returns d3 simulation object\n */\nfunction generateSimulation(dependencies) {\n    return d3.forceSimulation(dependencies)\n        .force('x0', d3.forceX())\n        .force('y0', d3.forceY())\n        .force('charge', d3.forceManyBody().strength(-300))\n        .force('link', d3.forceLink(computeEdges(dependencies)).distance(80).id(d => d.id));\n}\n\n/**\n * Compute the edges (links) for d3-force\n * as an array of objects {source: cm_id, target: cm_id}.\n * 1) filter out all elements with no dependencies;\n * 2) filter out all dependencies that are not type: completion\n * 3) for each remaining produce an edge with source and target, collecting also the operator.\n * 4) the operator is changed to 'negLit' if the literal is negated i.e. dep.c.e is 0 (activity must not be completed) \n */ \nfunction computeEdges(dependencies) {\n    return dependencies.filter(({id, name, dep}) => (dep !== null))\n        .flatMap(({id, name, dep}) => {\n            return dep.c.filter(x => x.type == 'completion').map(x => {return {target: id, source: x.cm, op: x.e ? dep.op : 'negLit'}})\n        });\n}\n\n/**\n * Use d3 to display nodes and edges (links).\n * @param simulation\n */\nfunction displayGraph(simulation) {\n    displayEdges(simulation.force('link').links());\n    displayNodesAndLabels(simulation.nodes());\n}\n\n/**\n * Add the graphical elements to display the edges.\n * The stroke-dasharray distingushes between the operator:\n * '&' (solid) - '|' dotted and all other cases dashdotted.\n * @param s_edges Edges (links) in the d3 simulation.\n */\nfunction displayEdges(s_edges) {\n    d3.select('svg').select('g').append('g').selectAll('line').data(s_edges)\n        .enter().append('line')\n        .attr('stroke', 'lightgray')\n        .attr('stroke-width', '2px')\n        .attr(\"stroke-linecap\", \"round\")\n        .attr('stroke-dasharray', x => (x.op == '&' ? '0 0' : (x.op == '|' ? '2 4' : '9 4 1 4')))\n        .attr('marker-end', 'url(#arrow)');\n}\n\n/**\n * Add the graphical elements to display the nodes and labels.\n * @param s_nodes Nodes in the d3 simulation.\n */\nfunction displayNodesAndLabels(s_nodes) {\n    d3.select('svg').select('g').append('g').selectAll('circle').data(s_nodes)\n        .join('circle')\n        .attr('fill', '#00a8d5')\n        .attr('stroke', 'white')\n        .attr('r', 5);\n    d3.select('svg').select('g').append('g').selectAll('text').data(s_nodes)\n        .join('text')\n        .attr('fill', 'darkgray')\n        .attr('font-family', 'sans-serif')\n        .attr('font-weight', 'bold')\n        .attr('font-size', 'small')\n      .clone().lower()\n        .attr('stroke', 'white')\n        .attr('stroke-width', 4)\n        .attr('stroke-opacity', 0.5);\n}\n\nlet edges, nodes, labels;\n\n/**\n * Save the graphical representation of edges, nodes and labals.\n */\nfunction rememberD3Selections() {\n    edges = d3.select('svg g').selectAll('line');\n    nodes = d3.select('svg g').selectAll('circle');\n    labels = d3.select('svg g').selectAll('text');\n}\n\n/**\n * Update the simulation.\n */\nfunction tick() {\n    nodes\n        .attr('cx', n => n.x)\n        .attr('cy', n => n.y);\n    edges\n        .attr('x1', e => e.source.x)\n        .attr('y1', e => e.source.y)\n        .attr('x2', e => e.target.x)\n        .attr('y2', e => e.target.y);\n    labels\n        .attr('x', n => n.x + 5)\n        .attr('y', n => n.y - 5)\n        .text(n => n.name);\n\n}\n\n/**\n * Make nodes draggable.\n * Once dragged a node is fixed to its assigned position in the simulation.\n * @param simulation\n */\nfunction makeDraggable(simulation) {\n    nodes\n        .call(d3.drag()\n        .on('start', (event, n) => {\n            if (!event.active) simulation.alphaTarget(0.3).restart();\n            n.fx = event.x;\n            n.fy = event.y;\n        })\n        .on('drag',\n            (event, n) => {\n                n.fx = event.x;\n                n.fy = event.y;\n            })\n        .on('end', (event) => {if (!event.active) simulation.alphaTarget(0);})\n        );\n}\n\n"],"file":"visualiseDependencies.min.js"}